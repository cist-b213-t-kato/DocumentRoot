<html>

<head>

	<meta charset="UTF-8"/>

	<title>CIST非公式サイト</title>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	<script src="https://momentjs.com/downloads/moment.min.js"></script>

	<!--script src="socket.io.js"></script-->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
	<script src="./js/teatimetable.js"></script>
	<script src="./js/jquery.cookie.js"></script>

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link href="./common.css" rel="stylesheet" />

	<style>
		.thread-button {
			margin: 2px;
		}

		.blind-top {
		    background: -webkit-gradient(linear, left top, left bottom, from(rgba(255,255,255,0)), color-stop(90%, #fefefe));
		    background: -webkit-linear-gradient(top, rgba(255,255,255,0) 0%, #fefefe 90%);
		    background: -o-linear-gradient(top, rgba(255,255,255,0) 0%, #fefefe 90%);
		    background: linear-gradient(to top, rgba(255,255,255,0) 0%, #fefefe 90%);
		    height: 50px;
		    margin: 0 0 -50px;
		    position: relative;
		    pointer-events: none;
		}

		.message-top {
			height:50px;
			font-size:20px;
			color:gray;
			width:100%;
			text-align:center;
			margin-bottom:10px;
			padding-top:20px;
			font-family:cursive;
			border-bottom: 1px solid lightgray;
			vertical-align: text-bottom;
		}

		.shuttlebus-content div {
			padding-left:5px;
			padding-right:5px;
		}

		.bold {
			font-weight: bold;
		}

		#message {
			list-style: none;
			-webkit-padding-start: 10px;
		}

		.namebody {
			/*position: relative;*/
		}

		.name-label {
			font-weight: bold;
			color: #666666;
			margin-right: 10px;
			/*float:left;*/
		}

		.date-label {
			/*font-weight: lighter;*/
			/*color: #CCCCCC;*/
			/*position: absolute;*/
			/*top: -20px;*/
			visibility: hidden;
			margin-top: -20px;
		}

		#message > li:hover {
			background-color: #AAAAAA;
			transition: all 300ms 0s ease;
		}

		#message > li:hover .date-label {
			/*font-weight: lighter;*/
			color: #FFFFFF;
			visibility: visible;
			transition: all 300ms 0s ease;
			/*text-shadow: 0 0 20px #000000;*/
			padding-left: 5px;
		}

		#message > li {
			padding: 1px 0px;
		}

		#message > li .body-label {
			margin-right: 5px;
		}



	</style>

</head>

<body>
	
  <div class="col-sm-12">
    <h1>CIST非公式サイト</h1>
      <!--p>裏サイトだと暗いイメージがあるので改名</p-->
		<p>アクセス数: <span id="counter"></span></p>
		<div><a href="./drawchat.html">お絵かき</a>（通信量が多少マシになりました）</div>
  </div>

  <div class="col-sm-12 shuttlebus-content">
    <h2>シャトルバス</h2>
	  <div>
	    <p>元のpdfは<a href="https://www.chitose.ac.jp/info/pdf/shuttlebus.pdf">こちら</a>。バス時刻表に間違いを見つけた人には飴ちゃんあげます。</p>
	    <p>小型版は<s><a href="./shuttlebus.html">こちら</a></s>。一旦封印。</p>
	  </div>

    <div class="col-sm-12">
    	<span class="large highlight">現在時刻: <span id="crt"></span></span>
    </div>

    <div id="shuttlebus-normal" class="col-sm-12">

	    <div class="col-sm-6">
		    <h3>往路</h3>
		    <table id="ouro"></table>
		  </div>

	    <div class="col-sm-6">
		    <h3>復路</h3>
		    <table id="fukuro"></table>
    		<p><span class="noriba2">朱色</span>は乗り場②</p>
	  	</div>

	  </div>

	  <div id="shuttlebus-dayoff" class="col-sm-12">
	    <p style="font-size:125%;color:#E07022;">JSONの功労者9:10氏を讃えよ</p>
	    <div class="col-sm-6">
		    <h3>休学期往路</h3>
		    <table id="dayoff-ouro"></table>
		  </div>

	    <div class="col-sm-6">
		    <h3>休学期復路</h3>
		    <table id="dayoff-fukuro"></table>
	  	</div>
  	</div>

  	<div class="col-sm-12">
    	<!-- <p style="font-size:40px; font-weight:bold;"><a href="https://twitter.com/kagichan_kyun">カギちゃん</a>なんか必要ねえんだよ（宣戦布告）</p> -->

  		<!-- <img src="./kagichan.png" /> -->
  	</div>

	</div>

  <div class="col-sm-12">
  	<h2>チャット</h2>

  	<!-- <div class="btn-group" data-toggle="buttons" style="margin-bottom:10px;"> -->
  	<div style="margin-bottom:10px;">

  		<span id="threadList" data-toggle="buttons">
				<label class="btn btn-default active thread-button" onclick="checkThread('');" >
					<input type="radio" autocomplete="off" checked> 未分類
				</label>
				<!-- <label class="btn btn-default" onclick="checkThread('アニメ');" >
					<input type="radio" autocomplete="off"> アニメ
				</label>
				<label class="btn btn-default" onclick="checkThread('ゲーム');" >
					<input type="radio" autocomplete="off"> ゲーム
				</label>
				<label class="btn btn-default" onclick="checkThread('お知らせ');" >
					<input type="radio" autocomplete="off"> お知らせ
				</label> -->
			</span>
			<label id='addThread' class="btn btn-default btn-primary" onclick="popAddThread();" > + </label>
			<form onsubmit="enterThreadSubmit(); return false;">
				<input id="addThreadInput" type="text" class="form-control" onblur="returnAddThread();">
			</form>

		</div>


	  <form onsubmit="viewMessage(); return false;">

  		<div class="blind-top" ></div>
		  <div id="message-box" style="height:300px;width:100%;overflow:scroll;">
		  	<div class="message-top">TOP</div>
		  	<ul id="message"></ul>
		  </div>
	  	<div class="form-group" style="width:28%; margin-bottom:5px; display:inline-block;">
	  		名前: <input type="text" id="name" class="form-control" autocomplete="off">
	  	</div>
	  	<div class="form-group" style="width:55%; margin-bottom:5px; display:inline-block;">
		  	本文: <input type="text" id="body" class="form-control" autocomplete="off">
		  </div>
		  <div class="form-group" style="width:13%; margin-bottom:5px; display:inline-block;">
				<button id="outButton" class="text-center center-block btn btn-primary">送信</button>
			</div>
		</form>
	</div>

  <div class="col-sm-12">
  	<a href="./examschedule.png"></a>
  </div>

  <div class="col-sm-4">
    <h2>プロメン成果物</h2>
    <h3>b216</h3>
    <ul>
			<!--<li><a href="./wicket-lecture">wicket-lecture</a></li>-->
			<li><a href="./trump">trump</a></li>
			<li><a href="./cist-cloud">cist-cloud</a></li>
    </ul>

    <h3>b215</h3>
    <ul>
        <li><a href="./PMPS">PMPS</a></li>
    </ul>

    <h3>m217</h3>
    <ul>
        <li><a href="./wicket-handson">wicket-handson</a></li>
        <li><a href="./ars">ars</a></li>
    </ul>
  </div>

  <div class="col-sm-4">
  	<h2>授業</h2>
  	<h3>情報科教育法</h3>
  	<ul>
  		<li><a href="./jokyo">ファイルまとめ</a></li>
  		<!-- <li><a href="./quantization1.html">量子化（ボタンとかなし）</a></li> -->
  	</ul>
  	<h3>輪講</h3>
  	<ul>
  		<li><a href="http://a.co/5xFo4Y8">よしたかさんの輪講おすすめリスト（amazonのほしいものリスト）</a></li>
  	</ul>
  </div>

  <div class="col-sm-4">
  	<h2>その他</h2>
  	<h3>学校の配布物</h3>
  	<ul>
  		<!-- <li class="large bold"><a href="examschedule.png">テストの時間割</a></li> -->
  		<li class="large bold"><a href="./pdf/opencampus.pdf">オープンキャンパス(8/4〜5)</a></li>
  		<li><a href="./schedule.pdf">時間割.pdf</a></li>
  		<li><a href="./guide.pdf">履修登録ガイド.pdf（主に大学行事のカレンダー用）</a></li>
  	</ul>
		<h3>中央バスのダイヤ</h3>
		<ul>
			<li><a href="./chuobus.html">確実に俺しか使わない</a></li>
		</ul>
		<h3>管理人のイラスト（誰得？）</h3>
		<ul>
			<li><a href="./illust">こちら</a></li>
		</ul>
  </div>

	<div class="col-sm-12" style="margin-bottom:100px;"></div>





















	<script type="text/javascript">

		// https://www.sejuku.net/blog/25316#Ajax

		$('#name').val($.cookie("name"));

		var crtThread = '';
		function checkThread( threadId ) {
			crtThread = threadId;
			console.log('checked: ' + crtThread);
			viewMessage();
		}

		var socket = io('http://54.92.8.231');

		function viewMessage() {
			// console.log('called viewMessage().');
			$.ajax({
        type : 'GET',
        url : 'http://54.92.8.231/get-message',
        data : { 
        	thread: crtThread 
        }
	    }).done(function(data, dataType) {
		    // console.log('succeed get-message');
				var message = $("#message");
				message.empty();
	    	for ( var i in data ) {
	      	var li = $("<li>");
	      	var namebody = $("<div class=\"namebody\">");
	      	namebody.append("<span class=\"name-label\">" + data[i].name + "</span>");
	      	namebody.append("<span class=\"body-label\">" + data[i].body + "</span>");
	      	li.append(namebody);

	      	var date = data[i].date;
	      	if ( date ) {
	      		li.append("<div class=\"date-label\">" + date + "</div>");
	      	}
			    // li.text(messageText);
			    message.append(li);
	    	}
		    $('#message-box').animate({scrollTop: $('#message-box')[0].scrollHeight}, 'slow');
			}).fail(function(result) {
			    console.log('失敗');
			});
		}
		viewMessage();

		$('#outButton').click(function() {
	    $.cookie('name', $("#name").val(), { expires:30 });
			var crtDate = new moment().format('YYYY/MM/DD HH:mm');
			$.ajax({
				type: 'POST',
				url: 'http://54.92.8.231/add-message',
				data : {
					name : $("#name").val(),
					body : $("#body").val(),
					thread : crtThread,
					date : crtDate
				}
		  }).done(function(result) {
			}).fail(function(result) {
			   console.log('失敗');
			});
			$("#body").val('');

			socket.emit('clientToServer', { my: 'client socket.emit()' });


			viewMessage();
		});

		/**
		 * thread 機能
		 */

		$('#addThreadInput').hide();

		function popAddThread() {
			// var input = $('<input>');
			// input.on('click', addThread);
			// $('#addThread').html(input);
			$('#addThread').hide();
			$('#addThreadInput').show();
		}

		function returnAddThread() {
			$('#addThreadInput').hide();
			$('#addThread').show();
		}

		function enterThreadSubmit() {
			var val = $('#addThreadInput').val();
			$('#addThreadInput').val('')
			console.log(val);
			addThread(val);
  		appendThread('#threadList', val);
  		checkThread(val);
			returnAddThread();
		}

		function addThread(threadName) {
			console.log('add-thread:');
			$.ajax({
				type: 'POST',
				url: 'http://54.92.8.231/add-thread',
				data : { name: threadName }
	    }).done(function(json) {
	    	// console.log("success");
			}).fail(function(json) {
		    console.log('failure');
			});
		}

		function appendThread(id, threadName) {
  		var label = $('<label>');
  		label.addClass('btn btn-default thread-button');
  		label.attr('onclick', 'checkThread(\'' + threadName + '\');');
  		//label.html();
  		var input = $('<input>');
  		input.attr('type', 'radio');
  		input.attr('autocomplete', 'off');
  		label.append(input);
  		label.append(threadName);
  		$(id).append(label);
		}

		// console.log('get-thread:');
		$.ajax({
			type: 'GET',
			url: 'http://54.92.8.231/get-thread',
			data : { }
    }).done(function(json) {
    	// console.log("success");
    	for ( var i in json ) {
    		var threadName = json[i].name;
    		appendThread('#threadList', threadName);
    	}
		}).fail(function(json) {
		    console.log('失敗');
		});

		$.ajax({
	    "url": "http://54.92.8.231/shuttlebus",
	    "dataType": "json"
		}).done(function(json) {

			var crt = new moment();
			$('#crt').text(crt.format('HH:mm'));

			// 休日
			var dayoffStart = moment("2018-08-04", "YYYY-MM-DD");
			var dayoffEnd = moment("2018-09-07", "YYYY-MM-DD");

			if ( crt.isBetween(dayoffStart, dayoffEnd) ) {
				/* 休学期ダイヤ */
				$('#shuttlebus-normal').hide();
				var dayoffOuro = new TeaTimeTable("#dayoff-ouro", json["dayoff-ouro"]);
				var dayoffFukuro = new TeaTimeTable("#dayoff-fukuro", json["dayoff-fukuro"]);
				dayoffOuro.whileUpdate(10);
				dayoffFukuro.whileUpdate(10);
				setInterval(function() {
					var crt = new moment();
					$('#crt').text(crt.format('HH:mm'));
				}, 10*1000);
			} else {
				/* 通常ダイヤ */
				$('#shuttlebus-dayoff').hide();
				var ouro = new TeaTimeTable("#ouro", json["ouro"]);
				var fukuro = new TeaTimeTable("#fukuro", json["fukuro"]);
				ouro.whileUpdate(10);
				fukuro.whileUpdate(10);
				setInterval(function() {
					var crt = new moment();
					$('#crt').text(crt.format('HH:mm'));
				}, 10*1000);
			}
		}).fail(function(data) {
	    console.log('ajax submit error!!!');
		});

		// $.ajax({
		//   "url": "http://54.92.8.231/counter",
		//   "dataType": "json"
		// }).done(function(json) {
		// 	$('#counter').text(json.count);
		// 	if ( json.count % 100 == 0 ) {
		// 		alert('おめでとうございます！あなたは'+json.count+'のお客様です。よろしければ管理者にキリ番報告してください。');
		// 	}
		// }).fail(function(data) {
		//   console.log('ajax submit error!!!');
		// });

		socket.on('message', function (data) {

			console.log('server to client');

			console.log('server: ' + data.message);
			viewMessage();

			// サーバへデータ送信
			// emit を使うとイベント名を指定できる
			//socket.emit('clientToServer', { my: 'client socket.emit()' });
		});









	</script>


</body>

</html>
